<img src="images/Hop.png" alt="Hop the Panda Logo" align="right"/>

The PANDA Compiler
==================

The PANDA Compiler is a tool that pre-processes a source file and extracts
parser relationship used to define a specific PANDA Parser.

# Code generation

The PANDA Compiler extracts the graph relationship of the parser defined in the
source file and uses this relationship to generate optimized C code that is then
used when called with the generated optimized parser.

# How it works

The PANDA compiler extracts a parse graph by matching the PANDA_* macros
that may be used to define a parser (see PANDA parser documentation). Note
that in order for the the panda-compiler to work a parser and all its parse
nodes need to be defined via the common macros.

From the PANDA_* macros that compiler is able to construct the parse graph
and annotations. Given this data structure, the compiler can then produce
linear C code sequences to execute the parser. The code sequence can have
several optimizations including unrolling of loops and parts of the path
in the parse graph. The output C code is then compiled to produce a binary.
To leverage the most C compiler optimization it is important to use "static
const" structures as much as possible and to restrict the parser definitions
to one execution unit.

Note that results will vary based on the aggressive of compiler optimizations.
Using gcc version 10 or greater seems to give good performance.

# How to use the compiler

The compiler is automatically used by the parsers defined in the PANDA library
itself, but if you want to optimize your own PANDA parser definition you can
call **panda_compiler** like this:

```bash
$ panda_compiler <input.c> <output.c>
```

Which will generate **output.c** which can be compiled in your own project to
accelerate your PANDA parser definition.

Not that the <output.c> file includes the <input.c> so that all the <input.c>
code is compiled with out change. Specifically, this means that the
unoptimized plain parser code is always compiled, and the additional code in
<output.c> is for compiling the optimized parser.

# How to use the code

If you want to use the optimized version, you must use the PANDA parser
generated by the compiler. The generated code creates a new parser by appending
to the parser name the suffix **_opt**, which you can call as you would the
non-generated parser.

```C
void foo ()
{
    panda_parse(my_own_parser_opt, hdr, len, &metadata, flags, max_encaps);
}
```

# Graph generation

The compiler reads the information from the parser definition and can also
generate a graph that shows the relationship and back edges (that define
encapsulations) from the graph defined in the parser definition.

To do that, you must call the panda compiler like this:

```bash
$ panda_compiler <input.c> <output.dot>
```

Please note the `.dot` extension. That selects the compiler to generate a `.dot`
graph, which can be used by graphviz and dot command-line to generate a graph
image like this:

```bash
$ dot -Tpng file.dot -o file.png
```

The graph will show the relationship between all defined nodes using the first
parser defined with its root node.
